---
import BlogLayout from "@/layouts/BlogLayout.astro";
import { formatDate, getTerms, type WpPost } from "@/lib/wordpress";

interface Props {
  post: WpPost;
}

const { post } = Astro.props;
const { categories, tags } = getTerms(post);
const postDate = post.date ? formatDate(post.date) : '';

// Extract featured image if available
let featuredImage = '';
if (post.jetpack_featured_media_url) {
  featuredImage = post.jetpack_featured_media_url;
} else if (post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
  featuredImage = post._embedded['wp:featuredmedia'][0].source_url;
}

// Extract author if available
let author = { name: '', avatar: '' };
if (post._embedded && post._embedded.author && post._embedded.author[0]) {
  author = {
    name: post._embedded.author[0].name,
    avatar: post._embedded.author[0].avatar_urls['96'] || ''
  };
}

// Get SEO description from excerpt if available
const description = post.excerpt?.rendered 
  ? post.excerpt.rendered.replace(/<\/?[^>]+(>|$)/g, '').trim() 
  : `${post.title.rendered} - SearchSerpa SEO Blog`;

// Set OG image if there's a featured image
const ogImage = featuredImage ? new URL(featuredImage) : undefined;
---

<BlogLayout 
  title={`${post.title?.rendered || 'Blog Post'} | SearchSerpa Blog`}
  description={description}
  ogImage={ogImage}
  post={post}
>
  <!-- Post metadata -->
  <div class="flex flex-wrap gap-4 mb-8 items-center text-muted-foreground text-sm">
    {postDate && (
      <div class="flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
        <time datetime={post.date}>{postDate}</time>
      </div>
    )}
    
    {author.name && (
      <div class="flex items-center gap-2">
        {author.avatar ? (
          <img src={author.avatar} alt={author.name} class="w-6 h-6 rounded-full" />
        ) : (
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        )}
        <span>{author.name}</span>
      </div>
    )}
    
    {categories.length > 0 && (
      <div class="flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder"><path d="M20 20a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2.5l2-3h5l2 3H18a2 2 0 0 1 2 2Z"/></svg>
        <div class="flex flex-wrap gap-2">
          {categories.map((category) => (
            <a href={`/blog/category/${category.slug}`} class="hover:text-primary transition-colors">
              {category.name}
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
  
  <!-- Featured image -->
  {featuredImage && (
    <figure class="mb-8">
      <img 
        src={featuredImage} 
        alt={post.title.rendered} 
        class="w-full rounded-lg max-h-[500px] object-cover"
      />
    </figure>
  )}
  
  <!-- Post content -->
  <article class="blog-content">
    <div set:html={post.content?.rendered || 'No content available'} />
  </article>
  
  <!-- Tags -->
  {tags.length > 0 && (
    <div class="mt-10 pt-6 border-t">
      <h3 class="text-lg font-semibold mb-3">Tags:</h3>
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => (
          <a 
            href={`/blog/tag/${tag.slug}`}
            class="px-3 py-1 bg-muted rounded-full text-xs hover:bg-primary hover:text-primary-foreground transition-colors"
          >
            {tag.name}
          </a>
        ))}
      </div>
    </div>
  )}
  
  <!-- CTA Section -->
  <div class="mt-16 p-8 bg-accent/20 border border-accent rounded-lg">
    <div class="text-center max-w-2xl mx-auto">
      <h3 class="text-xl font-bold mb-3">Ready to improve your SEO?</h3>
      <p class="mb-6">Let SearchSerpa guide your business to higher search rankings and increased organic traffic.</p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/#pricing" class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-6 py-2 text-sm font-medium text-primary-foreground transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          View Pricing Options
        </a>
        <a href="/" class="inline-flex h-10 items-center justify-center rounded-md border border-input bg-background px-6 py-2 text-sm font-medium transition-colors hover:bg-accent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          Free Site Audit
        </a>
      </div>
    </div>
  </div>
  
  <!-- Sidebar content (slots) -->
  {categories.length > 0 && (
    <div slot="sidebar-categories" class="mb-8">
      <h3 class="font-bold text-lg mb-4">Categories</h3>
      <ul class="space-y-2">
        {categories.map((category) => (
          <li>
            <a 
              href={`/blog/category/${category.slug}`} 
              class="flex items-center justify-between text-sm hover:text-primary transition-colors"
            >
              {category.name}
              <span class="bg-muted rounded-full w-6 h-6 flex items-center justify-center text-xs">
                {category.count || 1}
              </span>
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}
  
  {tags.length > 0 && (
    <div slot="sidebar-tags" class="mb-8">
      <h3 class="font-bold text-lg mb-4">Tags</h3>
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => (
          <a 
            href={`/blog/tag/${tag.slug}`}
            class="px-3 py-1 bg-muted rounded-full text-xs hover:bg-primary hover:text-primary-foreground transition-colors"
          >
            {tag.name}
          </a>
        ))}
      </div>
    </div>
  )}
</BlogLayout>