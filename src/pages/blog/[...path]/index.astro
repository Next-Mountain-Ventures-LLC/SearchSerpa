---
import BlogPostLayout from "@/layouts/BlogPostLayout.astro";
import BlogLayout from "@/layouts/BlogLayout.astro";
import { getPostBySlug, getSearchSerpaPosts, getFallbackPosts, formatWordPressContent } from "@/lib/wordpress";

// Mark this route as server-rendered
export const prerender = false;

// Extract the post slug from the WordPress-style URL path
// WordPress uses URLs like: /YYYY/MM/DD/post-slug/
function extractSlugFromPath(path: string[]): string {
  // If the path is empty, return empty string
  if (!path || path.length === 0) return '';
  
  // For WordPress-style URLs, the last segment is the slug
  return path[path.length - 1];
}

// Get the path from Astro.params
const { path } = Astro.params;
const pathSegments = Array.isArray(path) ? path : path ? [path] : [];

// Extract slug from path
const slug = extractSlugFromPath(pathSegments);
console.log(`Extracted slug: ${slug} from path: ${pathSegments.join('/')}`);

// Fetch the post data
let post;
try {
  post = await getPostBySlug(slug);
  console.log(`Found post: ${post?.title?.rendered || 'Not found'}`);
} catch (error) {
  console.error(`Error fetching post with slug ${slug}:`, error);
}

// Handle case where post might not have been found
if (!post) {
  console.log(`Post not found with slug: ${slug}, redirecting to 404`);
  return Astro.redirect("/404");
}

// Process WordPress content if needed
const processedContent = post.content?.rendered 
  ? formatWordPressContent(post.content.rendered)
  : '';
---

<BlogPostLayout post={post} />