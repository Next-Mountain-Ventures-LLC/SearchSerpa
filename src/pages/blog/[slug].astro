---
import BlogPostLayout from "@/layouts/BlogPostLayout.astro";
import { getPostBySlug, getSearchSerpaPosts, getFallbackPosts, getReadingTime } from "@/lib/wordpress";
import type { WpPost } from "@/lib/wordpress";

export async function getStaticPaths() {
  let posts: WpPost[] = [];

  // Try to fetch posts from WordPress API
  try {
    posts = await getSearchSerpaPosts({ perPage: 100 });
  } catch (error) {
    console.error("Error fetching posts from API:", error);
  }

  // If no posts are returned from API, use fallback posts
  if (posts.length === 0) {
    posts = getFallbackPosts();
  }

  // Create a path for each post
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

// Get props from getStaticPaths
const { post } = Astro.props;

// If the post was not found in getStaticPaths, try to fetch it directly
// This handles cases where new posts are added after the site is built
let finalPost = post;
if (!finalPost) {
  const slug = Astro.params.slug as string;
  try {
    finalPost = await getPostBySlug(slug);
  } catch (error) {
    console.error(`Error fetching post with slug ${slug}:`, error);
  }
  
  // If we still don't have a post, try to find it in fallbacks
  if (!finalPost) {
    const fallbackPosts = getFallbackPosts();
    finalPost = fallbackPosts.find(p => p.slug === slug) || null;
  }
}

// If no post is found, redirect to 404
if (!finalPost) {
  return Astro.redirect("/404");
}

// Extract post data
const {
  title,
  content,
  date,
  excerpt,
  _embedded
} = finalPost;

// Get featured image
const featuredImage = _embedded && _embedded['wp:featuredmedia']?.[0]?.source_url;

// Get author name
const author = _embedded?.author?.[0]?.name || "SearchSerpa Team";

// Get categories
const categories = _embedded?.['wp:term']?.[0]?.map(term => ({
  name: term.name,
  slug: term.slug
})) || [];

// Calculate reading time
const readingTime = getReadingTime(content.rendered);

// Clean post title (remove HTML)
const cleanTitle = title.rendered.replace(/<\/?[^>]+(>|$)/g, '');

// Clean excerpt for meta description
const cleanExcerpt = excerpt.rendered.replace(/<\/?[^>]+(>|$)/g, '').trim();
---

<BlogPostLayout
  title={cleanTitle}
  description={cleanExcerpt}
  date={date}
  featuredImage={featuredImage}
  author={author}
  readingTime={readingTime}
  categories={categories}
>
  <!-- Render the WordPress content -->
  <div set:html={content.rendered} />
</BlogPostLayout>