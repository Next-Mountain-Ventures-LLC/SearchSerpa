---
import BlogLayout from "@/layouts/BlogLayout.astro";
import { getSearchSerpaPosts, getCategories, getTags, getFeaturedImageUrl, formatDate, getFallbackPosts } from "@/lib/wordpress";

// Fetch blog posts from WordPress API with SearchSerpa category
let posts = [];
let categories = [];
let tags = [];

try {
  // Fetch posts and taxonomies in parallel
  const [postsResult, categoriesResult, tagsResult] = await Promise.all([
    getSearchSerpaPosts({ perPage: 12 }),
    getCategories(),
    getTags()
  ]);
  
  posts = postsResult;
  categories = categoriesResult.filter(cat => cat.slug !== 'searchserpa'); // Filter out SearchSerpa category
  tags = tagsResult;
} catch (error) {
  console.error("Error fetching data from WordPress API:", error);
  posts = getFallbackPosts();
}

// Sort posts by date (newest first)
posts.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());
---

<BlogLayout 
  title="SearchSerpa Blog | SEO Insights and Strategies" 
  description="Stay updated with the latest SEO tips, strategies, and insights from the SearchSerpa team."
>
  <!-- Blog Header -->
  <div class="text-center max-w-3xl mx-auto mb-16">
    <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold mb-4">
      SEO <span class="text-primary">Insights</span> & Strategies
    </h1>
    <p class="text-lg text-muted-foreground mb-8">
      Stay updated with the latest SEO tips, techniques, and industry insights from the SearchSerpa team.
    </p>
  </div>
  
  <!-- Post Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-16">
    {posts.map((post) => {
      // Get featured image if available
      const featuredImage = getFeaturedImageUrl(post, 'medium');
      const postDate = formatDate(post.date);
      
      // Extract excerpt and clean HTML tags
      let excerpt = post.excerpt?.rendered || '';
      excerpt = excerpt.replace(/<\/?[^>]+(>|$)/g, '').trim();
      if (excerpt.length > 120) {
        excerpt = excerpt.substring(0, 120) + '...';
      }
      
      return (
        <article class="flex flex-col h-full overflow-hidden bg-card rounded-lg border border-border shadow-sm hover:shadow-md transition-shadow">
          {/* Featured Image */}
          {featuredImage ? (
            <a href={`/blog/${post.slug}`} class="block aspect-video overflow-hidden">
              <img
                src={featuredImage}
                alt={post.title.rendered}
                class="w-full h-full object-cover transition-transform hover:scale-105"
              />
            </a>
          ) : (
            <div class="aspect-video bg-muted flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-muted-foreground opacity-30"><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2 2 0 0 1-2-2V7"/><path d="M6 7v3a2 2 0 0 1-2 2v0a2 2 0 0 1-2-2V7"/></svg>
            </div>
          )}
          
          {/* Content */}
          <div class="flex flex-col flex-grow p-5">
            <div class="text-sm text-muted-foreground mb-2">
              {postDate}
            </div>
            <h2 class="text-xl font-bold mb-3 line-clamp-2">
              <a href={`/blog/${post.slug}`} class="hover:text-primary transition-colors" set:html={post.title.rendered} />
            </h2>
            <p class="text-muted-foreground mb-4 text-sm line-clamp-3">
              {excerpt}
            </p>
            <div class="mt-auto pt-4">
              <a href={`/blog/${post.slug}`} class="inline-flex items-center font-semibold text-primary hover:underline gap-1">
                Read More
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
              </a>
            </div>
          </div>
        </article>
      )
    })}
  </div>
  
  <!-- CTA Banner -->
  <div class="bg-accent/20 border border-accent rounded-lg p-8 mb-16">
    <div class="text-center max-w-2xl mx-auto">
      <h2 class="text-2xl md:text-3xl font-bold mb-4">
        Ready to Climb to the <span class="text-primary">Top</span>?
      </h2>
      <p class="text-lg mb-8">
        Let SearchSerpa guide your business to the summit of search engine rankings.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="/" class="inline-flex h-10 items-center justify-center rounded-md bg-primary px-8 py-2 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          Get a Free Site Audit
        </a>
        <a href="/#pricing" class="inline-flex h-10 items-center justify-center rounded-md border border-input bg-background px-8 py-2 text-sm font-medium transition-colors hover:bg-accent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring">
          View Pricing Options
        </a>
      </div>
    </div>
  </div>
  
  <!-- Sidebar Categories -->
  <div slot="sidebar-categories" class="mb-8">
    <h3 class="font-bold text-lg mb-4">Categories</h3>
    {categories.length > 0 ? (
      <ul class="space-y-2">
        {categories.map((category) => (
          <li>
            <a 
              href={`/blog/category/${category.slug}`} 
              class="flex items-center justify-between text-sm hover:text-primary transition-colors"
            >
              {category.name}
              <span class="bg-muted rounded-full w-6 h-6 flex items-center justify-center text-xs">
                {category.count || 0}
              </span>
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p class="text-muted-foreground text-sm">No categories found</p>
    )}
  </div>
  
  <!-- Sidebar Tags -->
  <div slot="sidebar-tags" class="mb-8">
    <h3 class="font-bold text-lg mb-4">Tags</h3>
    {tags.length > 0 ? (
      <div class="flex flex-wrap gap-2">
        {tags.map((tag) => (
          <a 
            href={`/blog/tag/${tag.slug}`}
            class="px-3 py-1 bg-muted rounded-full text-xs hover:bg-primary hover:text-primary-foreground transition-colors"
          >
            {tag.name}
          </a>
        ))}
      </div>
    ) : (
      <p class="text-muted-foreground text-sm">No tags found</p>
    )}
  </div>
  
  <!-- Sidebar Newsletter -->
  <div slot="sidebar-recent" class="p-6 bg-muted rounded-lg mb-8">
    <h3 class="font-bold text-lg mb-3">Subscribe to Our Newsletter</h3>
    <p class="text-sm text-muted-foreground mb-4">
      Get the latest SEO tips and strategies delivered directly to your inbox.
    </p>
    <form class="space-y-3" data-form-type="utility">
      <div>
        <input 
          type="email" 
          name="email" 
          placeholder="Your email address" 
          class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
          required
        />
      </div>
      <button 
        type="submit"
        class="inline-flex h-10 w-full items-center justify-center rounded-md bg-primary px-4 py-2 text-sm font-medium text-primary-foreground transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring"
      >
        Subscribe
      </button>
    </form>
  </div>
</BlogLayout>